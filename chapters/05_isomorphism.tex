\chapter{The isomorphism $\Lam \cong \LamV$}
\label{c:isomorphism}

In~\cref{c:background}, the simply typed $\Lam$-calculus was introduced.
Now, we show an isomorphism between the system $\LamV$ introduced in the previous chapter and the simply typed $\Lam$-calculus.
This isomorphism will come at the level of terms, reduction, $\beta$-normal forms and typing rules.

This isomorphism is of great interest as $\LamV$ typing rules resemble a sequent calculus style.
In this sense, the isomorphism studided in this chapter establishes a correspondence between natural deduction system (the simply typed $\Lam$-calculus) and a fragment of sequent calculus (the system $\LamV$).
The chapter is inspired in the works~\cite{LuisDychkoff} and~\cite[Chapter~4]{JCES2002} and is summarized by the following diagram:

% https://q.uiver.app/#q=WzAsNCxbMiwwLCJcXGJveGVke1xcdmVjIFxcbGFtYmRhfSJdLFsyLDIsIlxcYm94ZWR7XFxzbWFsbHtcXHZlYyBcXGJldGEtbmZzfX0iXSxbMCwwLCJcXGJveGVkXFxsYW1iZGEiXSxbMCwyLCJcXGJveGVke1xcc21hbGx7XFxiZXRhLW5mc319Il0sWzAsMSwiXFxkb3duYXJyb3dfe1xcdmVjIFxcYmV0YX0iLDFdLFsyLDMsIlxcZG93bmFycm93X1xcYmV0YSIsMV0sWzMsMSwiXFxjb25nIiwxLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiYXJyb3doZWFkIn19fV0sWzIsMCwiXFxwc2kiLDEseyJvZmZzZXQiOi0yfV0sWzAsMiwiXFx0aGV0YSIsMSx7Im9mZnNldCI6LTJ9XV0=
\[\begin{tikzcd}
    {\boxed\lambda} && {\boxed{\vec \lambda}} \\
    \\
    {\boxed{\text{NF}}} && {\boxed{\text{NT}}}
    \arrow["\psi"{description}, shift left=2, from=1-1, to=1-3]
    \arrow["{\downarrow_\beta}"{description}, from=1-1, to=3-1]
    \arrow["\theta"{description}, shift left=2, from=1-3, to=1-1]
    \arrow["{\downarrow_{\beta}}"{description}, from=1-3, to=3-3]
    \arrow["\cong"{description}, <->, from=3-1, to=3-3]
  \end{tikzcd}\]

% The $\vec \beta$ refers to the $\beta$-reduction steps in system $\LamV$ and is used in the diagram to create a clear distinction.
In this diagram: the horizontal arrows symbolize the inverse maps underlying the isomorphism; the down arrows symbolize (partial) maps associating expressions to the respective beta-normal form (when existing).
Also recall the sets NF$\subset \Lam$-terms and NT$\subset \LamV$-terms of the respective $\beta$-normal forms.

\section{Mappings $\theta$ and $\psi$}

We start by defining the maps between expressions of $\Lam$ and $\LamV$ underlying the isomorphism.

\begin{definition}[Maps $\theta$ and $\theta'$]
  The map $\theta : \LamV \text{-terms} \to \Lam \text{-terms}$ is defined simultaneously with the map $\theta' : (\Lam \text{-terms} \times \LamV \text{-lists}) \to \Lam \text{-terms}$ by recursion on $\LamV$-terms and $\LamV$-lists respectively, as follows:
  \begin{center}
  \begin{tabular}{cc}
    $ \begin{aligned}[t]
      \theta(var(x)) &= x \\
      \theta(\lambda x . t) &= \lambda x . \theta(t) \\
      \theta(app_v(x, u, l)) &= \theta'(x, u::l) \\
      \theta(app_\lambda (x.t, u, l)) &= \theta'(\lambda x . \theta(t), u::l)
    \end{aligned} $
    & \quad
    $ \begin{aligned}[t] \\
      \theta'(M, [])   &= M \\
      \theta'(M, u::l) &= \theta'(M \ \theta(u), l).
    \end{aligned} $
  \end{tabular}
  \end{center}
\end{definition}
  
\begin{definition}Maps $\psi$ and $\psi'$
  The map $\psi' : (\Lam \text{-terms} \times \LamV \text{-lists}) \to \LamV \text{-terms}$ is defined by recursion on $\Lam$-terms as follows:
  \begin{align*}
    \psi(x, []) &= var(x) \\
    \psi(x, u::l) &= app_v (x, u, l) \\
    \psi(\lambda x . M, []) &= \lambda x . \psi(M) \\
    \psi(\lambda x . M, u::l) &= app_\lambda (x . \psi(M), u, l) \\
    \psi(M N, l) &= \psi'(M, \psi(N)::l),              
  \end{align*}
  where $\psi(M)$ is easily defined as $\psi'(M, [])$.
\end{definition}

\subsection{Bijection at the level of terms}

Now, we will establish that $\theta$ and $\psi$ are indeed inverse maps, and thus, $\Lam$-terms and $\LamV$-terms are in bijection.

\begin{lemma}
  \label{theta_inversion_lemma}
  \begin{align*}
    \theta \circ \psi' &= \theta'    
  \end{align*}
\end{lemma}
\begin{proof}
  The proof proceeds by induction on the structure of $\Lam$-terms and proper inspection of the $\LamV$-list in the variable and abstraction cases.
\end{proof}


\begin{theorem}[$\theta$ is left inverse of $\psi$]
  \label{theta_psi_inversion}
  \begin{align*}
    \theta \circ \psi &= id_{\Lam \text{-terms}}
  \end{align*}
\end{theorem}
\begin{proof}
  Immediate using~\cref{theta_inversion_lemma}.
\end{proof}


\begin{theorem}[$\psi$ is left inverse of $\theta$]
  \label{psi_theta_inversion}
  \begin{align*}
    \psi \circ \theta &= id_{\LamV \text{-terms}} \\
    \psi \circ \theta' &= \psi'    
  \end{align*}
\end{theorem}
\begin{proof}
  The proof proceeds by simultaneous induction on the structure of $\LamV$-terms and $\LamV$-lists, respectively.
\end{proof}


\subsection{Isomorphism at the level of reduction}

Now we turn our attention to reduction, showing that the reduction relations $\to_\beta$ of $\Lam$-calculus and $\LamV$ are isomorphic.

First, introduce some lemmata, in order to relate the mappings $\theta'$ and $\psi'$ with the @ operation and list append.

\begin{lemma}
  \label{theta_app_lemma}
  For every $\LamV$-terms $t, u$ and $\LamV$-list $l$,
  \[ \theta(t@(u, l)) = \theta'(\theta(t) \ \theta(u), l) \]
  and also, for every $\Lam$-term $M$, $\LamV$-term $u'$ and $\LamV$-lists $l, l'$,
  \[ \theta'(M, l+(u'::l')) = \theta'(\theta'(M, l) \ \theta(u'), l'). \]
\end{lemma}
\begin{proof}
  The proof proceeds easily by simultaneous induction on the structure of the $\LamV$-term $t$ and $\LamV$-list $l$, respectively.
\end{proof}

\begin{corollary}
  \label{psi_app_lemma}
  For every $\Lam$-term $M$, $\LamV$-term $u$ and $\LamV$-list $l$,
  \[ \psi'(M, u :: l) = \psi(M)@(u, l). \]
\end{corollary}
\begin{proof}
  The result follows as a corollary of~\cref{theta_app_lemma}, using~\cref{psi_theta_inversion} and~\cref{theta_inversion_lemma} to rewrite the left-hand side of the equality.
\end{proof}

Using the previous lemmas, the preservation of the substitution operations by $\theta$ and $\psi$ follow.

\begin{lemma}
  \label{theta_subst_lemma}
  For every $\LamV$-terms $t, u$,
  \[ \theta(t[x := u]) = \theta(t)[x := \theta(u)] \]
  and also, for every $\Lam$-term $M$,  $\LamV$-term $u$ and $\LamV$-list $l$,
  \[ \theta'(M[x := \theta(u)], l[x := u]) = \theta'(M, l)[x := u]. \]
\end{lemma}
\begin{proof}
  The proof follows by simultaneous induction on the structure of $t$ and $l$, using~\cref{theta_app_lemma}.
\end{proof}
  
\begin{lemma}
  \label{psi_subst_lemma}
  For every $\Lam$-terms $M, N$ and $\LamV$-list $l$,
  \[ \psi'(M[x := N], l[x := \psi(N)]) = \psi'(M, l)[x := \psi(N)]. \]
\end{lemma}
\begin{proof}
  The proof follows by induction on the structure of $\Lam$-term $M$, using~\cref{psi_app_lemma}.
\end{proof}

Now, we are essentially ready to obtain the isomorphism at the level of reduction.

\begin{lemma}
  \label{theta_step_lemma}
  For every $\Lam$-terms $M, N$ and $\LamV$-list $l$,
  \[ M \to_{\beta} N \implies \theta'(M, l) \to_{\beta} \theta'(N, l). \]
\end{lemma}
\begin{proof}
  The proof follows easily by induction on the structure of the $\LamV$-list $l$.
\end{proof}

\begin{theorem}[Preservation of reduction by $\theta$]
  \label{theta_step_pres}
  For every $\LamV$-terms $t, t'$,
  \[ t \to_{\beta} t' \implies \theta(t) \to_{\beta} \theta(t') \]
  and also, for every $\Lam$-term $M$ and $\LamV$-lists $l, l'$,
  \[ l \to_{\beta} l' \implies \theta'(M, l) \to_{\beta} \theta(M, l'). \]
\end{theorem}
\begin{proof}
  The proof proceeds by simultaneous induction on the structure of the step relation on $\LamV$-expressions.

  \cref{theta_app_lemma} is useful for the cases of compatibility steps.

  \cref{theta_subst_lemma} is crucial for cases dealing with $\beta$ steps.
\end{proof}


\begin{theorem}[Preservation of reduction by $\psi'$]
  \label{psi_step_pres}
  For every $\Lam$-terms $M, N$ and $\LamV$-list $l$,
  \[ M \to_{\beta} N \implies \psi'(M, l) \to_{\beta} \psi'(N, l). \]
\end{theorem}
\begin{proof}
  The proof proceeds by induction on the structure of the step relation on $\Lam$-terms.

  \cref{psi_subst_lemma} is crucial for cases dealing with $\beta$ steps.
\end{proof}

Of course that the preservation of reduction by map $\psi$ follows trivially by the previous theorem, as $\psi$ is a particular case of $\psi'$.

Summarising our isomorphism at the level of reduction, we state the following corollary.

\begin{corollary}[Isomorphism of reduction] \hfill
  
  \begin{enumerate}
  \item $t \to_{\beta} t' \text{ in } \LamV \iff \theta(t) \to_{\beta} \theta(t') \text{ in } \Lam$
  \item $M \to_{\beta} N \text{ in } \Lam \iff \psi(M) \to_{\beta} \psi(N) \text{ in } \LamV$
  \end{enumerate}
\end{corollary}
\begin{proof}
  Immediate by \cref{theta_psi_inversion,psi_theta_inversion,theta_step_pres,psi_step_pres}.
\end{proof}

% ---

\subsection{Isomorphism at the level of $\beta$-normal forms}

Now, we will argue that the bijection between $\Lam$-terms and $\LamV$-terms still holds when we restrict to $\beta$-normal forms.
For this, is convenient to recall both~\cref{beta_nfs} and~\cref{beta_nfs_can}.
% Here, a direct proof for the preservation of normal forms is given.
% However, we also give a hint on how this could be proved using~\cref{beta_nfs_claim,beta_nfs_can_claim}.

\begin{theorem}[$\theta$ preserves $\beta$-nfs]
  \label{theta_nfs_pres}
  \[ t \in \text{NT} \implies \theta(t) \in \text{NF} \]
\end{theorem}
\begin{proof}
  Given $t \in$ NT, by~\cref{beta_nfs_can_claim}, there exists no $t'$ such that $t \to_\beta t'$ (or $t$ is a $\beta$-nf).

  Now let us prove that $\theta(t)$ is a $\beta$-nf.

  Suppose there exists a $\Lam$-term $N$ such that $\theta(t) \to_\beta N$.
  From~\cref{psi_step_pres}, it is also true that $\psi(\theta(t)) \to_\beta \psi(N)$.
  And, using~\cref{psi_theta_inversion}, we may rewrite $\psi(\theta(t))$ as $t$, obtaining a contradiction as $t \to_\beta \psi(N)$ while $t$ is a $\beta$-nf.

  Therefore, such $N$ cannot exist and $\theta(t)$ is a $\beta$-nf (consequently, from~\cref{beta_nfs_claim}, $\theta(t) \in \text{NF})$.
\end{proof}

We can prove an analogous result for $\psi$. 

\begin{theorem}[$\psi$ preserves $\beta$-nfs]
  \[ M \in \text{NF} \implies \psi(M) \in \text{NT} \]
\end{theorem}
\begin{proof}
  Analogous to the proof of~\cref{theta_nfs_pres}.
\end{proof}

% As an alternative path to obtain the previous theorem, from the assumption that $M \in \text{NF}$, using~\cref{beta_nfs_claim}, one gets that $M$ is in $\beta$-normal form.
% Then, from~\cref{psi_step_pres}, $\psi(M)$ is also in $\beta$-normal form (for system $\LamV$), which in turn means that $\psi(M) \in \text{NT}$ (by~\cref{beta_nfs_can_claim}).

\subsection{Isomorphism at the level of typed terms}

Finally, we complete the proof of our isomorphism by showing a 1-1 correspondence between typed terms of the simply typed $\Lam$-calculus and system $\LamV$.

\begin{theorem}[$\theta$ admissibility]
  % \label{some_theorem_name}
  The following rules hold:
  \[ \begin{prooftree}
      \hypo{ \Gamma \vdash t : A }
      \infer1{ \Gamma \vdash \theta(t) : A } 
    \end{prooftree}
    \qquad \qquad
    \begin{prooftree}
      \hypo{ \Gamma \vdash M : A }
      \hypo{ \Gamma ; A \vdash l : B }
      \infer2{ \Gamma \vdash \theta'(M, l) : B }.
    \end{prooftree} \]
\end{theorem}
\begin{proof}
  The proof proceeds easily by simultaneous induction on the structure of the typing derivations in the system $\LamV$.
\end{proof}

\begin{theorem}[$\psi'$ admissibility]
  % \label{theorem12}
  The following rule holds:
  \[ \begin{prooftree}
      \hypo{ \Gamma \vdash M : A }
      \hypo{ \Gamma ; A \vdash l : B }
      \infer2{ \Gamma \vdash \psi'(M, l) : B }.
    \end{prooftree} \]
\end{theorem}
\begin{proof}
  The proof proceeds easily by induction on the structure of the typing derivations in the simply typed $\Lam$-calculus.
\end{proof}

% ---

\section{Mechanisation in \textit{Rocq}}

In this section we provide a brief description of the mechanisation of the concepts and results described in the previous section.
Essentially, we just defined maps $\theta$ and $\psi$ and mechanised each of the results provided.

One detail that should be highlighted is the definition for maps $\theta$ and $\theta'$.
\begin{lstlisting}[language=Coq]
Fixpoint theta (t: Canonical.term) : Lambda.term :=
  match t with
  | Vari x => Var x
  | Lamb t => Lam (theta t)
  | VariApp x u l => fold_left (fun s v => App s (theta v)) (u::l) (Var x)
  | LambApp t u l => fold_left (fun s v => App s (theta v)) (u::l) (Lam (theta t))
  end.

Definition theta' (s: Lambda.term) (l: list Canonical.term) :
  Lambda.term := fold_left (fun s v => App s (theta v)) l s.
\end{lstlisting}

The mechanised object that represents map $\theta'$ uses a higher order function on lists called \lst$fold_left$ that behaves exactly as $\theta'$, given the function \lst$(fun s v => App s (theta v))$ which folds the $\LamV$-list into a $\Lam$-term.

Such representation of map $\theta$ was an undesired consequence of the use of polymorphic lists in the definition for $\LamV$-terms.
We could not define mutually recursive functions on the structure of the term and list because the proof assistant fails to recognise their termination~\cite{YvesStackOverflow}.
Instead, we have to define these maps using higher order functions.
In this specific case, we could even enjoy the generality of the \lst$fold_left$ function.
Unfortunately, with such definition for $\theta'$, we had to repeatedly fold the definition for $\theta'$ in our proofs to make the goal more readable (hiding the calls to the \lst$fold_left$).
This necessity of ``folding'' a definition can be seen in the mechanisation of~\cref{theta_step_lemma}:
\begin{lstlisting}[language=Coq]
Lemma theta'_step_pres l :
  forall s s', Lambda.step s s' -> Lambda.step (theta' s l) (theta' s' l).
Proof.
  induction l as [| u l]; intros ; asimpl ; try easy.
  - fold (theta' (App s (theta u)) l).
    fold (theta' (App s' (theta u)) l).
    apply IHl. now constructor.
Qed.
\end{lstlisting}


%%% Local Variables:
%%% mode: LaTeX
%%% TeX-master: "../dissertation"
%%% End:
